<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BIOL550 Lab 3 Report</title>
  <style>
    body { font-family: "Times New Roman", Times, serif; font-size: 12pt; margin: 16px; line-height: 1.15; color: #111; }
    h1, h2, h3 { margin: 0 0 8px 0; }
    h1 { text-align: center; }
    .subtitle { text-align: center; font-size: 11pt; margin: 0 0 12px 0; }
    h2 { margin-top: 16px; }
    p { text-align: justify; margin: 0 0 10px 0; }
    pre { background: #f5f5f5; padding: 10px; border: none; box-shadow: none; outline: none; overflow-x: auto; font-size: 11px; }
    code { font-family: Menlo, Consolas, monospace; font-size: 9px; }
    pre code { font-size: 9px; }
    .note { font-style: italic; margin-top: 6px; }
    img { max-width: 60%; height: auto; display: block; margin: 8px auto; }
    .figure-title { text-align: center; font-size: 11pt; margin: 4px 0 10px 0; }
    .img-row { display: flex; gap: 16px; align-items: flex-start; justify-content: center; margin: 8px 0 10px 0; }
    .img-col { flex: 0 1 420px; }
    .img-row img { max-width: 100%; margin: 0 auto; }
    @media print {
      body { margin: 0.75in; }
      pre { white-space: pre-wrap; word-break: break-word; border: none !important; box-shadow: none !important; outline: none !important; }
      .img-row { break-inside: avoid; }
    }
  .img-col p.note{
    font-size: 12px;   /* match your code size */
    line-height: 1.1;
    margin: 4px 0 0 0;
    text-align: center;
  }
  </style>
</head>
<body>

  <h1>Trapnell Data Set - Differential Expression (cuffdiff)</h1>
  <div class="subtitle">BIOL550 - Lab 3 Weekly Report (Week 3)</div>

  <h2>What I accomplished since the previous report</h2>
  <p>
    I produced a set of STAR BAM files that include the <code>XS</code> strand tag required by <code>cuffdiff</code>, and then ran <code>cuffdiff</code> on all six samples (3 C1 replicates and 3 C2 replicates) to complete the Trapnell differential expression step. I exported the <code>cuffdiff</code> output directory locally, summarized gene-level results from <code>gene_exp.diff</code> using <code>q_value &lt;= 0.05</code>, and generated two sanity-check figures (volcano plot + top-DE bar chart).
  </p>

  <h3>Results summary</h3>
  <pre><code>Lab 3: Cuffdiff gene-level DE summary
OK tests: 8289
Significant genes (q&lt;=0.05): 265
Top up (by log2FC): Fatp, crc, scf, CTPsyn, Df31
Top down (by log2FC): Nep2, RpS19b, Amy-d, CG6847, Aplip1</code></pre>

  <h2>Methods used (commands + parameters)</h2>
  <p>
    STAR was used to generate sorted coordinate BAMs, and <code>cuffdiff</code> was used for differential expression on the aligned reads. Then, downstream filtering and plotting were done locally from the <code>cuffdiff</code> output tables.
  </p>

  <h3>STAR re-alignment (to ensure <code>XS</code> tags)</h3>
  <p>
    STAR was re-run for all six samples with <code>--outSAMstrandField intronMotif</code> so that spliced alignments include <code>XS</code> tags. 
    <!-- Representative command: -->
  </p>
  <pre><code>STAR \
  --genomeDir /home/pzg8794/star_index/classref_trapnell_zip_bdgp6_84_v2 \
  --runThreadN 4 \
  --sjdbGTFfile "/home/pzg8794/BIOL550/Lab1/Trapnell_Data/Trapnell Data/Drosophila reference/Drosophila_melanogaster.BDGP6.84.gtf" \
  --readFilesIn \
    "/home/pzg8794/BIOL550/Lab1/Trapnell_Data/Trapnell Data/Raw reads/GSM794483_C1_R1_1.fq.gz" \
    "/home/pzg8794/BIOL550/Lab1/Trapnell_Data/Trapnell Data/Raw reads/GSM794483_C1_R1_2.fq.gz" \
  --readFilesCommand zcat \
  --outSAMtype BAM SortedByCoordinate \
  --outSAMstrandField intronMotif \
  --limitBAMsortRAM 6000000000 \
  --outFileNamePrefix /home/pzg8794/BIOL550/Lab1/star_align_classref_v2_all_xs/GSM794483_C1_R1/</code></pre>

  <h3>Differential expression (<code>cuffdiff</code>)</h3>
  <p>
    The Drosophila reference directory includes both a GTF and a GFF3; the GTF (<code>Drosophila_melanogaster.BDGP6.84.gtf</code>) was used because <code>cuffdiff</code> expects GTF2 annotation (GFF3 would require conversion before use). <code>Cuffdiff</code> was run on the XS-tagged BAMs (3 replicates per condition) with bias correction enabled via <code>-b</code>.
  </p>
  <pre><code>/usr/local/bin/cufflinks/cuffdiff \
  -o /home/pzg8794/BIOL550/Lab1/cuffdiff_classref_v2_xs \
  -p 4 \
  -L C1,C2 \
  -b /home/pzg8794/refs/classref_bdgp6_84_ids_v2.fa \
  "/home/pzg8794/BIOL550/Lab1/Trapnell_Data/Trapnell Data/Drosophila reference/Drosophila_melanogaster.BDGP6.84.gtf" \
  /home/pzg8794/BIOL550/Lab1/star_align_classref_v2_all_xs/GSM794483_C1_R1/Aligned.sortedByCoord.out.bam,/home/pzg8794/BIOL550/Lab1/star_align_classref_v2_all_xs/GSM794484_C1_R2/Aligned.sortedByCoord.out.bam,/home/pzg8794/BIOL550/Lab1/star_align_classref_v2_all_xs/GSM794485_C1_R3/Aligned.sortedByCoord.out.bam \
  /home/pzg8794/BIOL550/Lab1/star_align_classref_v2_all_xs/GSM794486_C2_R1/Aligned.sortedByCoord.out.bam,/home/pzg8794/BIOL550/Lab1/star_align_classref_v2_all_xs/GSM794487_C2_R2/Aligned.sortedByCoord.out.bam,/home/pzg8794/BIOL550/Lab1/star_align_classref_v2_all_xs/GSM794488_C2_R3/Aligned.sortedByCoord.out.bam</code></pre>



  <h3>Downstream summary (local)</h3>
  <p>
    From the file<code>gene_exp.diff</code>, I filtered valid tests by keeping rows where <code>status == "OK"</code>, and defined significance at <code>q_value &lt;= 0.05</code>. Then, I generated a volcano plot (log2FC vs. -log10 p-value) and a top-gene bar chart (ranked by log2FC) as sanity checks on effect-size distribution and signal presence.
  </p>
  <!-- <p>
    For the resubmission file requested in feedback, I exported only the columns needed for interpretation (<code>gene</code> and <code>q_value</code>) for significant results.
  </p>
  <p class="note">
    Resubmission file: <code>exports/cuffdiff_classref_v2_xs/differential_results_gene_qvalues.tsv</code> (columns: <code>gene</code>, <code>q_value</code>).
  </p> -->

<div class="img-row">
  <div class="img-col">
    <h3>Volcano plot</h3>
    <img src="figures/volcano_gene_exp_python.png"
         alt="Volcano plot (gene_exp.diff)"
         style="height: 300px; width: auto;" />
    <div class="figure-title">Volcano plot: <code>gene_exp.diff</code></div>
  </div>

  <div class="img-col">
    <h3>Top 20 DE genes bar chart</h3>
    <img src="figures/top20_bar_log2fc.png"
         alt="Top 20 DE genes bar chart"
         style="height: 300px; width: auto;" />
    <div class="figure-title">Top DE genes (by log2FC)</div>
  </div>
</div>

<p>
  These two figures summarize gene-level differential expression from <code>gene_exp.diff</code>. The volcano plot places each gene by effect size (x = log2 fold-change, C1 vs C2) and statistical evidence (y = -log10(p)), while significance is evaluated after multiple-testing correction using the FDR-adjusted <code>q_value</code> (genes with <code>q_value &lt;= 0.05</code> are highlighted in red). Most genes cluster near log2FC ~ 0 with low -log10(p), consistent with little or no change, whereas a smaller set rises into the upper tails where the estimated difference is large relative to replicate variability. In this run there were 8,289 valid ("OK") tests and 265 significant genes, with a strong bias toward C1-up regulation (257 up vs 8 down); the vertical guides at log2FC = -1 and +1 mark roughly 2-fold changes. The top-20 bar chart makes the largest effects explicit, including <code>Fatp</code> (~1.77), <code>crc</code> (~1.45), <code>scf</code> (~1.41), <code>CTPsyn</code> (~1.40), and <code>Df31</code> (~1.36) as prominent increases and <code>Nep2</code> (~ -0.99) and <code>RpS19b</code> (~ -0.85) as prominent decreases. Biologically, these hits are consistent with a condition-associated shift affecting metabolism and regulation (e.g., lipid transport/metabolism via <code>Fatp</code>, nucleotide metabolism via <code>CTPsyn</code>, and chromatin/nuclear organization via <code>Df31</code>), motivating follow-up at the pathway/process level (GO/pathways) rather than over-weighting individual gene names.
</p>

  
<h2>Problems encountered</h2>
<p>
  The first issue was annotation format: the reference folder includes both a GTF and a GFF3 file. The GFF3 file uses <code>ID=</code>/<code>Parent=</code> attributes, whereas the GTF uses the <code>gene_id</code>/<code>transcript_id</code> fields. After inspecting both files, I used the GTF (<code>Drosophila_melanogaster.BDGP6.84.gtf</code>) because it was the most compatible with STAR and <code>cuffdiff</code> with minimal changes. The second issue was that the initial STAR BAMs from Lab 2 did not contain <code>XS</code> strand tags on spliced reads, which caused <code>cuffdiff</code> to fail. This required going back and re-aligning all six samples with <code>--outSAMstrandField intronMotif</code> to produce XS-tagged BAMs.
</p>

<!-- <p>

    Finally, FastQC "FAIL" flags from the raw data (quality/GC-related modules) were not resolved by earlier trimming attempts. Because STAR mapping performance remained strong after alignment, I proceeded with the same input reads rather than applying additional aggressive filtering that could reduce usable read depth.
  </p> -->

<h2>Goals for the coming week</h2>
<p>
  Next week I will (1) further explore and improve the visualization workflow (e.g., volcano and MA-style plots) to better interpret the <code>cuffdiff</code> outputs, (2) run the FASTQ "dump" workflow for our zebrafish project data using the SRA Toolkit (<code>prefetch</code> + <code>fasterq-dump</code>) and validate our wrapper script for downloading an arbitrary number of runs, and (3) run <code>FastQC</code> on the downloaded FASTQs and begin reviewing the QC reports to guide downstream analysis.
</p>


</body>
</html>
